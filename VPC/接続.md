# 🌐 VPC（Virtual Private Cloud）の概念整理

## 1. VPCとは

- **AWS上に構築する論理的に分離された仮想ネットワーク**
    
- 例えるなら「AWS上に自分専用のデータセンターを作る」イメージ
    
- 利用者はIPアドレス範囲、サブネット、ルーティング、セキュリティ設定を自由に制御可能
    

---

## 2. VPCの主要コンポーネント

### 🔹 **CIDRブロック**

- VPC作成時に割り当てるプライベートIPアドレス空間
    
- 例: `10.0.0.0/16` → サブネットに分割して利用
    

### 🔹 **サブネット**

- VPC内をさらに分割したネットワークセグメント
    
- **パブリックサブネット**: インターネットと通信可能（IGW経由）
    
- **プライベートサブネット**: インターネットに直接出ない（NATやVPCエンドポイント経由）
    

### 🔹 **ルートテーブル**

- トラフィックの転送先を制御
    
- 例: `0.0.0.0/0 → Internet Gateway` → インターネット通信可能
    

### 🔹 **Internet Gateway (IGW)**

- VPCとインターネットを接続するゲートウェイ
    
- パブリックサブネットから外部アクセスするために必須
    

### 🔹 **NAT Gateway / NAT Instance**

- プライベートサブネットから外部へ通信するための仕組み
    
- 外部からの直接アクセスは不可
    
- 例: yum update / apt-get update / API通信など
    

### 🔹 **VPC Endpoints**

- AWSサービス（S3, DynamoDBなど）に**インターネットを介さずプライベート接続**
    
- 2種類
    
    - **Gateway型**（S3, DynamoDB）
        
    - **Interface型**（ENI経由で各種サービス）
        

### 🔹 **Security Group / NACL**

- **SG（セキュリティグループ）**: インスタンス単位の仮想ファイアウォール（ステートフル）
    
- **NACL**: サブネット単位のアクセス制御リスト（ステートレス）
    

### 🔹 **Peering / PrivateLink / Transit Gateway**

- **VPC Peering**: 2つのVPC間で直接通信
    
- **PrivateLink**: VPCからサービス提供（エンドポイントサービス）
    
- **Transit Gateway**: 複数VPCやオンプレを集約して接続
    

---

## 3. VPCの設計パターン

### 🔹 パブリック & プライベートサブネット構成

- Webサーバー → パブリックサブネット
    
- DBサーバー → プライベートサブネット
    
- NAT Gateway → プライベートサブネットから外部通信
    

### 🔹 マルチAZ冗長構成

- 可用性を高めるために複数AZにサブネットを配置
    
- RDSやELBはマルチAZ必須構成
    

### 🔹 ハイブリッド構成

- オンプレとVPCを接続
    
- VPNまたはDirect Connectを利用
    
- さらに冗長化する場合は **Direct Connect + VPN 冗長**
    

---

## 4. 試験でよく問われる観点

1. **パブリックとプライベートの違い**  
    → IGWにルートがあるかないか
    
2. **NAT GatewayとVPC Endpointの使い分け**
    
    - S3にプライベートサブネットから接続する → NAT経由よりも **VPC Endpoint(Gateway型)** が最適
        
3. **セキュリティグループ vs NACL**
    
    - SGはステートフル、NACLはステートレス
        
    - SGはホワイトリスト型、NACLはDenyルールも設定可能
        
4. **VPCピアリングの制約**
    
    - 転送（トランジティブ通信）は不可
        
    - CIDRが重複していると設定不可
        

---

# ✅ まとめ

- **VPC = AWS上の仮想データセンター**
    
- 基本構成要素: **サブネット / IGW / NAT / Route Table / SG / NACL**
    
- サービス接続: **VPC Endpoint / Peering / PrivateLink / Transit Gateway**
    
- 設計の肝: **パブリック・プライベート分離 + マルチAZ冗長化 + ハイブリッド接続**

ここでは **VPC内部のセキュリティ制御（SG, NACL）** と **アプリ/ネットワーク保護（WAF, Shield, GuardDutyなど）** を整理します。

---

# 🔐 VPCセキュリティ設計

## 1. **セキュリティグループ（SG）**

- **インスタンス単位の仮想ファイアウォール**
    
- **ステートフル**（リクエストを許可すればレスポンスは自動許可）
    
- ルールは **許可のみ（deny不可）**
    
- よく使うパターン：
    
    - Webサーバー → `80, 443` を世界に開放
        
    - DBサーバー → `3306` を WebサーバーのSGにのみ許可
        

✅ ポイント：**SG同士を参照できる（動的制御が可能）**

---

## 2. **ネットワークACL（NACL）**

- **サブネット単位のファイアウォール**
    
- **ステートレス**（戻りトラフィックも明示的に許可が必要）
    
- **許可（Allow）・拒否（Deny）ルール**の両方を設定可能
    
- 適用順序：番号の小さいルールから評価（ルール番号 100 → 200 → 300 …）
    

✅ ユースケース：

- **明示的に拒否が必要な場合**（例: 特定IPをブロック）
    
- サブネット全体に広く制御をかけたい場合
    

---

## 3. **AWS WAF（Web Application Firewall）**

- **アプリ層（L7, HTTP/HTTPS）を防御**
    
- DDoS対策やSQLインジェクション、XSS、ボットアクセスをブロック
    
- 適用対象：
    
    - CloudFront
        
    - ALB
        
    - API Gateway
        
    - AppSync
        

✅ ユースケース：

- Webアプリを公開していて **アプリケーション層の脅威対策**が必要な場合
    

---

## 4. **AWS Shield**

- **DDoS防御サービス**
    
- **Shield Standard**: 全AWSユーザーに無償提供（基本的なL3/L4 DDoS防御）
    
- **Shield Advanced**: 有償、24/7対応・高度なDDoS防御・コスト保護付き
    

✅ ユースケース：

- 公開Webアプリで大規模DDoS対策が必要な場合（金融、ECサイトなど）
    

---

## 5. **Amazon GuardDuty**

- **脅威検出サービス**
    
- 機械学習や脅威インテリジェンスを使って、悪意ある動きを検出
    
- 分析対象：
    
    - **VPC Flow Logs**（不審な通信）
        
    - **CloudTrail**（不審なAPI操作）
        
    - **DNSログ**（悪意あるドメインへのアクセス）
        

✅ ユースケース：

- 不正アクセス検出、マルウェア感染兆候、C2通信の早期発見
    

---

## 6. **セキュリティ設計の組み合わせパターン**

### 🔹 基本的な3層構成（Web / App / DB）

1. **SG**
    
    - Web層 → Internet 80/443許可
        
    - App層 → Web SGからのみ許可
        
    - DB層 → App SGからのみ許可
        
2. **NACL**
    
    - 不要な外部IPを拒否
        
    - 管理者アクセス範囲を制限
        
3. **WAF + Shield**
    
    - ALBやCloudFrontに配置してアプリ層とネットワーク層を防御
        
4. **GuardDuty**
    
    - 常時監視・アラート通知（CloudWatch Event / Security Hub連携）
        

---

## 7. 試験対策で問われやすい観点

- **SGはステートフル / NACLはステートレス**
    
- **SGは許可のみ、NACLは拒否も可**
    
- **明示的にブロックが必要 → NACL**
    
- **アプリケーション層の攻撃対策 → WAF**
    
- **L3/L4 DDoS防御 → Shield**
    
- **脅威検出（IDS/IPS的役割） → GuardDuty**
    
- **VPC内部の通信監査や調査 → VPC Flow Logs**
    

---

# ✅ まとめ

- **SG → インスタンス単位の基本防御（許可のみ）**
    
- **NACL → サブネット単位の広域制御（許可・拒否）**
    
- **WAF → L7アプリ攻撃対策**
    
- **Shield → L3/L4 DDoS防御**
    
- **GuardDuty → 脅威検知 & インシデント対応補助**
    

---

SAAレベルでは「どのサービスで何を監視するのか」、SAPレベルでは「ログの保存・分析・組織全体の統合設計」が問われます。

---

# 📊 VPCモニタリング & ログ管理

## 1. **VPC Flow Logs**

- **VPC・サブネット・ENIレベルの通信ログを記録**
    
- 記録内容：
    
    - 通信の送信元/宛先IP、ポート、プロトコル
        
    - 通信許可/拒否（SG・NACLで制御された結果も確認可能）
        
- 出力先：
    
    - CloudWatch Logs
        
    - S3
        
- ユースケース：
    
    - セキュリティ調査（不審IPとの通信）
        
    - ネットワークトラブルシューティング
        
    - GuardDutyとの連携で脅威検出
        

✅ ポイント（試験で問われやすい）

- **パケットの中身は記録されない**（ヘッダー情報のみ）
    
- **CloudWatch Logs or S3に保存可能**
    

---

## 2. **AWS CloudTrail**

- **すべてのAWS APIコールを記録**
    
- 記録内容：
    
    - 誰が（IAMユーザー/ロール）
        
    - いつ
        
    - どのサービスに
        
    - どんな操作をしたか
        
- 出力先：
    
    - S3（長期保管）
        
    - CloudWatch Logs（リアルタイム分析）
        
- ユースケース：
    
    - 監査対応（PCI DSS, HIPAAなど）
        
    - 誤操作や不正アクセスの追跡
        
    - GuardDutyと連携して「不審なAPI利用」を検知
        

✅ ポイント（試験で問われやすい）

- **マネジメントプレーンのログを取る → CloudTrail**
    
- **データプレーンのログ（例: S3 GET/PUT）も取れる**
    

---

## 3. **Amazon CloudWatch**

- **監視・メトリクス・アラートの中心サービス**
    
- 機能：
    
    - **CloudWatch Metrics**: CPU利用率、ディスクI/O、ネットワークトラフィックなど数値化
        
    - **CloudWatch Logs**: アプリやOSログを集約
        
    - **CloudWatch Alarms**: メトリクス閾値を超えたら通知/自動アクション
        
    - **CloudWatch Dashboards**: 可視化
        
- ユースケース：
    
    - EC2のCPU過負荷検知 → Auto Scaling連携
        
    - アプリケーションログの分析（ログイン失敗の増加など）
        
    - CloudTrail / VPC Flow Logsの保存先として利用
        

✅ ポイント（試験で問われやすい）

- **リアルタイム監視 → CloudWatch**
    
- **履歴・操作証跡 → CloudTrail**
    
- **通信ログ → VPC Flow Logs**
    

---

# 4. **サービス間連携イメージ**

`┌────────────┐ │    VPC Flow Logs     │  → 通信可否/トラフィック └────────────┘           │           ▼   S3 / CloudWatch Logs           │           ▼     GuardDuty（脅威検出） ┌────────────┐ │     CloudTrail       │  → API操作ログ └────────────┘           │           ▼   S3 / CloudWatch Logs           │           ▼   Security Hub / GuardDuty ┌────────────┐ │   CloudWatch        │  → メトリクス/アラーム └────────────┘           │           ▼  Auto Scaling / SNS通知`

---

# ✅ まとめ（試験対策）

- **VPC Flow Logs** → 通信の可否・ネットワーク監査
    
- **CloudTrail** → APIコール記録、監査証跡
    
- **CloudWatch** → メトリクス監視、アラーム、自動アクション
    
- **GuardDuty** → Flow Logs & CloudTrailを解析して脅威検出
    

👉 SAA試験では **「どのサービスでどのログを取るか」**  
👉 SAP試験では **「ログをどこに保存し、どう統合分析するか（Athena, OpenSearch, Security Hub連携など）」**